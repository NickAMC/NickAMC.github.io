<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nick Climaco">
<meta name="dcterms.date" content="2024-04-16">

<title>Decision Trees and Random Forest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="notebook_files/libs/clipboard/clipboard.min.js"></script>
<script src="notebook_files/libs/quarto-html/quarto.js"></script>
<script src="notebook_files/libs/quarto-html/popper.min.js"></script>
<script src="notebook_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="notebook_files/libs/quarto-html/anchor.min.js"></script>
<link href="notebook_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="notebook_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="notebook_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="notebook_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="notebook_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#objective" id="toc-objective" class="nav-link active" data-scroll-target="#objective">Objective :</a></li>
  <li><a href="#data-cleaning-eda" id="toc-data-cleaning-eda" class="nav-link" data-scroll-target="#data-cleaning-eda">Data Cleaning / EDA</a></li>
  <li><a href="#model-building" id="toc-model-building" class="nav-link" data-scroll-target="#model-building">Model Building</a>
  <ul class="collapse">
  <li><a href="#decisiontree-model-1-normal" id="toc-decisiontree-model-1-normal" class="nav-link" data-scroll-target="#decisiontree-model-1-normal">DecisionTree Model 1 : Normal</a></li>
  <li><a href="#decisiontree-model-2-forced-split" id="toc-decisiontree-model-2-forced-split" class="nav-link" data-scroll-target="#decisiontree-model-2-forced-split">DecisionTree Model 2 : Forced Split</a></li>
  <li><a href="#random-forest-model" id="toc-random-forest-model" class="nav-link" data-scroll-target="#random-forest-model">Random Forest Model</a></li>
  </ul></li>
  <li><a href="#model-variance-analysis" id="toc-model-variance-analysis" class="nav-link" data-scroll-target="#model-variance-analysis">Model Variance Analysis</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Decision Trees and Random Forest</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nick Climaco </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 16, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="objective" class="level1">
<h1>Objective :</h1>
<ol type="1">
<li><p>Based on the latest topics presented, choose a dataset of your choice and create a Decision Tree where you can solve a classification problem and predict the outcome of a particular feature or detail of the data used.</p></li>
<li><p>Switch variables* to generate 2 decision trees and compare the results. Create a random forest and analyze the results.</p></li>
<li><p>Based on real cases where desicion trees went wrong, and ‘the bad &amp; ugly’ aspects of decision trees (https://decizone.com/blog/the-good-the-bad-the-ugly-of-using-decision-trees), how can you change this perception when using the decision tree you created to solve a real problem?</p></li>
</ol>
<hr>
</section>
<section id="data-cleaning-eda" class="level1">
<h1>Data Cleaning / EDA</h1>
<p>The <a href="https://www.kaggle.com/datasets/anandshaw2001/airlines-reviews-and-rating">Airline Reviews and Rating</a> dataset from Kaggle was selected because this dataset allows for the tackling of a practical classification problem. The combination of textual reviews and numerical ratings presents a chance to explore sentiment analysis and decision tree skills.</p>
<p>The target variable is the <code>Recommended</code> column where customer decide whether to recommed the airline based on their travel experience.</p>
<p>There 3 types of features:</p>
<ul>
<li><p>numerical where the customer rates different aspects such as <code>Value for Money</code> or <code>Cabin Staff Service</code> on a scale of 1-5 where 5 is the best.</p></li>
<li><p>categorical where the customer bought a economy or business class ticket.</p></li>
<li><p>text where the customer wrote about their experience while traveling with certan airlines.</p></li>
</ul>
<div id="cell-5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># load libraries </span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'c:/Users/nickc/DataScience/NickAMC.github.io/D622-S24/hw2/Airlines Reviews and Rating.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>df.describe().T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Seat Comfort</td>
<td>3176.0</td>
<td>2.833123</td>
<td>1.360588</td>
<td>1.0</td>
<td>2.0</td>
<td>3.0</td>
<td>4.0</td>
<td>5.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Cabin Staff Service</td>
<td>3165.0</td>
<td>3.228752</td>
<td>1.486388</td>
<td>1.0</td>
<td>2.0</td>
<td>3.0</td>
<td>5.0</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Ground Service</td>
<td>2812.0</td>
<td>2.795519</td>
<td>1.455301</td>
<td>1.0</td>
<td>1.0</td>
<td>3.0</td>
<td>4.0</td>
<td>5.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Food &amp; Beverages</td>
<td>2911.0</td>
<td>2.678461</td>
<td>1.435562</td>
<td>0.0</td>
<td>1.0</td>
<td>3.0</td>
<td>4.0</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Wifi &amp; Connectivity</td>
<td>592.0</td>
<td>1.923986</td>
<td>1.355305</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>3.0</td>
<td>5.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Inflight Entertainment</td>
<td>2171.0</td>
<td>2.654537</td>
<td>1.386722</td>
<td>0.0</td>
<td>1.0</td>
<td>3.0</td>
<td>4.0</td>
<td>5.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Value For Money</td>
<td>3290.0</td>
<td>2.636474</td>
<td>1.459832</td>
<td>1.0</td>
<td>1.0</td>
<td>3.0</td>
<td>4.0</td>
<td>5.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a>sns.boxplot(data<span class="op">=</span>df, orient<span class="op">=</span><span class="st">'h'</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb4-5"><a href="#cb4-5"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Aircraft Type</th>
<th data-quarto-table-cell-role="th">Users Reviews</th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">Type_of_Travellers</th>
<th data-quarto-table-cell-role="th">Route</th>
<th data-quarto-table-cell-role="th">Seat_Types</th>
<th data-quarto-table-cell-role="th">Seat Comfort</th>
<th data-quarto-table-cell-role="th">Date Flown</th>
<th data-quarto-table-cell-role="th">Cabin Staff Service</th>
<th data-quarto-table-cell-role="th">Ground Service</th>
<th data-quarto-table-cell-role="th">Food &amp; Beverages</th>
<th data-quarto-table-cell-role="th">Wifi &amp; Connectivity</th>
<th data-quarto-table-cell-role="th">Inflight Entertainment</th>
<th data-quarto-table-cell-role="th">Value For Money</th>
<th data-quarto-table-cell-role="th">Recommended</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>NaN</td>
<td>✅Trip Verified| Cancelled our flight last-min...</td>
<td>United Kingdom</td>
<td>Couple Leisure</td>
<td>London Heathrow to Tokyo</td>
<td>Economy Class</td>
<td>1.0</td>
<td>Sep-23</td>
<td>1.0</td>
<td>2.0</td>
<td>1.0</td>
<td>NaN</td>
<td>3.0</td>
<td>1</td>
<td>no</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>NaN</td>
<td>✅Trip Verified| I had a flight from Miami, Flo...</td>
<td>United States</td>
<td>Solo Leisure</td>
<td>Miami to Dublin via London Heathrow</td>
<td>Business Class</td>
<td>1.0</td>
<td>Aug-23</td>
<td>3.0</td>
<td>1.0</td>
<td>2.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1</td>
<td>no</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>NaN</td>
<td>✅Trip Verified| We started our day with BA in...</td>
<td>United States</td>
<td>Business</td>
<td>Prague to San Francisco via London</td>
<td>Business Class</td>
<td>1.0</td>
<td>Sep-23</td>
<td>3.0</td>
<td>1.0</td>
<td>3.0</td>
<td>1.0</td>
<td>NaN</td>
<td>1</td>
<td>no</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NaN</td>
<td>✅Trip Verified| I fly British Airways weekly ...</td>
<td>United Kingdom</td>
<td>Business</td>
<td>London to Glasgow</td>
<td>Economy Class</td>
<td>1.0</td>
<td>Sep-23</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1</td>
<td>no</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NaN</td>
<td>Not Verified| Everything was ok until our con...</td>
<td>France</td>
<td>Family Leisure</td>
<td>San Diego to Marseille via London</td>
<td>Economy Class</td>
<td>3.0</td>
<td>Aug-23</td>
<td>2.0</td>
<td>1.0</td>
<td>3.0</td>
<td>1.0</td>
<td>3.0</td>
<td>3</td>
<td>no</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>missing_values_count <span class="op">=</span> df.isnull().<span class="bu">sum</span>().to_frame(name<span class="op">=</span><span class="st">'Missing Values'</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>missing_values_count[<span class="st">'Missing Percentage'</span>] <span class="op">=</span> (missing_values_count[<span class="st">'Missing Values'</span>] <span class="op">/</span> <span class="bu">len</span>(df) <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a>missing_values_count[<span class="st">'Missing Percentage'</span>] <span class="op">=</span> missing_values_count[<span class="st">'Missing Percentage'</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb6-5"><a href="#cb6-5"></a>missing_values_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Missing Values</th>
<th data-quarto-table-cell-role="th">Missing Percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Aircraft Type</td>
<td>1394</td>
<td>42.37</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Users Reviews</td>
<td>0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Country</td>
<td>1</td>
<td>0.03</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Type_of_Travellers</td>
<td>403</td>
<td>12.25</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Route</td>
<td>407</td>
<td>12.37</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Seat_Types</td>
<td>3</td>
<td>0.09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Seat Comfort</td>
<td>114</td>
<td>3.47</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Date Flown</td>
<td>410</td>
<td>12.46</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Cabin Staff Service</td>
<td>125</td>
<td>3.80</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Ground Service</td>
<td>478</td>
<td>14.53</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Food &amp; Beverages</td>
<td>379</td>
<td>11.52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Wifi &amp; Connectivity</td>
<td>2698</td>
<td>82.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Inflight Entertainment</td>
<td>1119</td>
<td>34.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Value For Money</td>
<td>0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Recommended</td>
<td>0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Due to high proportion of missingness the columns <code>Aircraft Type</code> and <code>Wifi &amp; Connectivity</code> will be dropped.</p>
<div id="cell-12" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>df.drop([<span class="st">'Aircraft Type'</span>, <span class="st">'Wifi &amp; Connectivity'</span>], inplace <span class="op">=</span> <span class="va">True</span>, axis <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Initially, I wanted to drop the user reviews column but I found the SIA function that quickly performs a sentiment analysis on the users reviews.</p>
<div id="cell-14" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> nltk</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="im">from</span> nltk.sentiment <span class="im">import</span> SentimentIntensityAnalyzer</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>sia <span class="op">=</span> SentimentIntensityAnalyzer()</span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co"># use sentiment analysis base on column usersreview. output should positive 1 or negative 0</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>df[<span class="st">'Review Sentiment'</span>] <span class="op">=</span> df[<span class="st">'Users Reviews'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">'1'</span> <span class="cf">if</span> sia.polarity_scores(x)[<span class="st">'compound'</span>] <span class="op">&gt;=</span> <span class="fl">0.05</span> <span class="cf">else</span> <span class="st">'0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-15" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>df.drop([<span class="st">'Country'</span>, <span class="st">'Users Reviews'</span>,<span class="st">'Route'</span>, <span class="st">'Date Flown'</span>], axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">#  deal with the missingness</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>df <span class="op">=</span> df.dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>df.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Type_of_Travellers        0
Seat_Types                0
Seat Comfort              0
Cabin Staff Service       0
Ground Service            0
Food &amp; Beverages          0
Inflight Entertainment    0
Value For Money           0
Recommended               0
Review Sentiment          0
dtype: int64</code></pre>
</div>
</div>
<p>There 4 unique <code>Seat_Types and</code>Type_of_Travellers`. We will need to use an encoder to convert these catogorical values to numeric. Initially, we tried using LabelEncoder() but it ran the risk of not treating the classes fairly. This may be true in the real-world but our DT model doesnt know that and its introduce unwanted bias. Thus, we ended up using OneHotEncoder() create binary columns indicate the whether or not it is that category.</p>
<div id="cell-19" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>df[<span class="st">'Seat_Types'</span>].unique().tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>['Economy Class', 'Business Class', 'Premium Economy', 'First Class']</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>df[<span class="st">'Type_of_Travellers'</span>].unique().tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>['Couple Leisure', 'Solo Leisure', 'Business', 'Family Leisure']</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a>categorical_columns <span class="op">=</span> [<span class="st">'Seat_Types'</span>, <span class="st">'Type_of_Travellers'</span>]</span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a>encoder <span class="op">=</span> OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a>encoded_data <span class="op">=</span> encoder.fit_transform(df[categorical_columns]).toarray()</span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9"><a href="#cb17-9"></a>new_col_names <span class="op">=</span> encoder.get_feature_names_out(categorical_columns)</span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a>df_encoded <span class="op">=</span> pd.DataFrame(encoded_data, columns<span class="op">=</span>new_col_names)</span>
<span id="cb17-12"><a href="#cb17-12"></a></span>
<span id="cb17-13"><a href="#cb17-13"></a>df_final <span class="op">=</span> pd.concat([df.reset_index(), df_encoded],axis <span class="op">=</span> <span class="dv">1</span>) <span class="co"># concat requireds matching indices</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>df_final.drop([<span class="st">'index'</span>,<span class="st">'Type_of_Travellers'</span>,<span class="st">'Seat_Types'</span>], axis <span class="op">=</span> <span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>df_final.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Seat Comfort</th>
<th data-quarto-table-cell-role="th">Cabin Staff Service</th>
<th data-quarto-table-cell-role="th">Ground Service</th>
<th data-quarto-table-cell-role="th">Food &amp; Beverages</th>
<th data-quarto-table-cell-role="th">Inflight Entertainment</th>
<th data-quarto-table-cell-role="th">Value For Money</th>
<th data-quarto-table-cell-role="th">Recommended</th>
<th data-quarto-table-cell-role="th">Review Sentiment</th>
<th data-quarto-table-cell-role="th">Seat_Types_Business Class</th>
<th data-quarto-table-cell-role="th">Seat_Types_Economy Class</th>
<th data-quarto-table-cell-role="th">Seat_Types_First Class</th>
<th data-quarto-table-cell-role="th">Seat_Types_Premium Economy</th>
<th data-quarto-table-cell-role="th">Type_of_Travellers_Business</th>
<th data-quarto-table-cell-role="th">Type_of_Travellers_Couple Leisure</th>
<th data-quarto-table-cell-role="th">Type_of_Travellers_Family Leisure</th>
<th data-quarto-table-cell-role="th">Type_of_Travellers_Solo Leisure</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1.0</td>
<td>1.0</td>
<td>2.0</td>
<td>1.0</td>
<td>3.0</td>
<td>1</td>
<td>no</td>
<td>1</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.0</td>
<td>3.0</td>
<td>1.0</td>
<td>2.0</td>
<td>1.0</td>
<td>1</td>
<td>no</td>
<td>0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>1</td>
<td>no</td>
<td>0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3.0</td>
<td>2.0</td>
<td>1.0</td>
<td>3.0</td>
<td>3.0</td>
<td>3</td>
<td>no</td>
<td>0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2.0</td>
<td>2.0</td>
<td>1.0</td>
<td>2.0</td>
<td>3.0</td>
<td>1</td>
<td>no</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>df_final.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(1739, 16)</code></pre>
</div>
</div>
<p>Checking if the encoding created the desired outcome and not added unwanted NaN values.</p>
<div id="cell-26" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>df_final.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Seat Comfort                         0
Cabin Staff Service                  0
Ground Service                       0
Food &amp; Beverages                     0
Inflight Entertainment               0
Value For Money                      0
Recommended                          0
Review Sentiment                     0
Seat_Types_Business Class            0
Seat_Types_Economy Class             0
Seat_Types_First Class               0
Seat_Types_Premium Economy           0
Type_of_Travellers_Business          0
Type_of_Travellers_Couple Leisure    0
Type_of_Travellers_Family Leisure    0
Type_of_Travellers_Solo Leisure      0
dtype: int64</code></pre>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>class_counts <span class="op">=</span> df_final[<span class="st">'Recommended'</span>].value_counts()</span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a>plt.bar(class_counts.index, class_counts.values)</span>
<span id="cb24-4"><a href="#cb24-4"></a>plt.xlabel(<span class="st">'Recommended'</span>)</span>
<span id="cb24-5"><a href="#cb24-5"></a>plt.ylabel(<span class="st">'Count'</span>)</span>
<span id="cb24-6"><a href="#cb24-6"></a>plt.title(<span class="st">'Class Imbalance in Target Variable'</span>)</span>
<span id="cb24-7"><a href="#cb24-7"></a></span>
<span id="cb24-8"><a href="#cb24-8"></a>total <span class="op">=</span> <span class="bu">sum</span>(class_counts.values)</span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="cf">for</span> i, count <span class="kw">in</span> <span class="bu">enumerate</span>(class_counts.values):</span>
<span id="cb24-10"><a href="#cb24-10"></a>     percentage <span class="op">=</span> count <span class="op">/</span> total <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb24-11"><a href="#cb24-11"></a>     plt.text(i, count, <span class="ss">f'</span><span class="sc">{</span>percentage<span class="sc">:.2f}</span><span class="ss">%'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb24-12"><a href="#cb24-12"></a></span>
<span id="cb24-13"><a href="#cb24-13"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can tackle htis class imbalance in the train_test_split() where we will set the stratify argument equal to the target set. Although, DecisionTrees are relatively more robust to class imbalances than other ML models it is not immune to it.</p>
<div id="cell-29" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a>X <span class="op">=</span> df_final.drop(<span class="st">'Recommended'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2"></a>y <span class="op">=</span> df[[<span class="st">'Recommended'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>X.shape, y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>((1739, 15), (1739, 1))</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>airline_df_pp <span class="op">=</span> pd.concat([X,y], axis <span class="op">=</span><span class="dv">1</span>, ignore_index<span class="op">=</span>)</span>
<span id="cb28-2"><a href="#cb28-2"></a>airline_df_pp.to_csv(<span class="st">'airline_df_pp.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-building" class="level1">
<h1>Model Building</h1>
<p>Now that we have cleaned, encoding, and assigned sentiment to the data. We can train and test our Decion Tree model.</p>
<div id="cell-34" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>SEED <span class="op">=</span> <span class="dv">123</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a>X_train,X_test,y_train, y_test <span class="op">=</span> train_test_split(X,y, test_size <span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span> SEED, stratify<span class="op">=</span>y )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="decisiontree-model-1-normal" class="level2">
<h2 class="anchored" data-anchor-id="decisiontree-model-1-normal">DecisionTree Model 1 : Normal</h2>
<div id="cell-37" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="co">#  grid search to find the optimal parameters</span></span>
<span id="cb31-2"><a href="#cb31-2"></a></span>
<span id="cb31-3"><a href="#cb31-3"></a>param_grid <span class="op">=</span> {</span>
<span id="cb31-4"><a href="#cb31-4"></a>    <span class="st">'criterion'</span>: [<span class="st">'gini'</span>, <span class="st">'entropy'</span>],</span>
<span id="cb31-5"><a href="#cb31-5"></a>    <span class="st">'max_depth'</span>: <span class="bu">range</span>(<span class="dv">3</span>,<span class="dv">10</span>),</span>
<span id="cb31-6"><a href="#cb31-6"></a>    <span class="st">'min_samples_leaf'</span>: [<span class="fl">0.1</span>, <span class="fl">0.15</span>,<span class="fl">0.2</span>, <span class="fl">0.25</span>]  </span>
<span id="cb31-7"><a href="#cb31-7"></a> }</span>
<span id="cb31-8"><a href="#cb31-8"></a></span>
<span id="cb31-9"><a href="#cb31-9"></a>dt <span class="op">=</span> DecisionTreeClassifier(random_state<span class="op">=</span>SEED) </span>
<span id="cb31-10"><a href="#cb31-10"></a>grid_search <span class="op">=</span> GridSearchCV(dt, param_grid, cv<span class="op">=</span><span class="dv">5</span>, scoring<span class="op">=</span><span class="st">'accuracy'</span>)  </span>
<span id="cb31-11"><a href="#cb31-11"></a>grid_search.fit(X_train, y_train)</span>
<span id="cb31-12"><a href="#cb31-12"></a></span>
<span id="cb31-13"><a href="#cb31-13"></a>best_params <span class="op">=</span> grid_search.best_params_</span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="bu">print</span>(best_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'criterion': 'gini', 'max_depth': 3, 'min_samples_leaf': 0.1}</code></pre>
</div>
</div>
<div id="cell-38" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>dt1 <span class="op">=</span> DecisionTreeClassifier(criterion<span class="op">=</span><span class="st">'gini'</span>, max_depth<span class="op">=</span><span class="dv">3</span>, min_samples_leaf<span class="op">=</span><span class="fl">0.1</span>, random_state<span class="op">=</span>SEED)</span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>dt1.fit(X_train, y_train)</span>
<span id="cb33-4"><a href="#cb33-4"></a></span>
<span id="cb33-5"><a href="#cb33-5"></a>y_pred  <span class="op">=</span> dt1.predict(X_test)</span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="bu">print</span>(<span class="ss">f'DT Model 1 Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred)<span class="sc">:.3%}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DT Model 1 Accuracy: 90.805%</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a><span class="im">from</span> sklearn <span class="im">import</span> tree</span>
<span id="cb35-2"><a href="#cb35-2"></a></span>
<span id="cb35-3"><a href="#cb35-3"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb35-4"><a href="#cb35-4"></a>tree.plot_tree(dt, feature_names<span class="op">=</span>X_train.columns, class_names<span class="op">=</span>[<span class="st">'Not Recommend'</span>, <span class="st">'Recommend'</span>], filled<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-5"><a href="#cb35-5"></a>plt.title(<span class="st">'Decision Tree Model 1'</span>)</span>
<span id="cb35-6"><a href="#cb35-6"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NotFittedError: This DecisionTreeClassifier instance is not fitted yet. Call 'fit' with appropriate arguments before using this estimator.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1200x800 with 0 Axes&gt;</code></pre>
</div>
</div>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a>importance_dt <span class="op">=</span> pd.Series(dt.feature_importances_, index <span class="op">=</span> X_train.columns)</span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a>importance_sorted_dt <span class="op">=</span> importance_dt.sort_values()</span>
<span id="cb38-4"><a href="#cb38-4"></a></span>
<span id="cb38-5"><a href="#cb38-5"></a>importance_sorted_dt.plot(kind<span class="op">=</span><span class="st">'barh'</span>, color <span class="op">=</span> <span class="st">'blue'</span>)</span>
<span id="cb38-6"><a href="#cb38-6"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The analysis revealed <code>Value for Money</code> was the most influential feature in this decision tree moidel. This demonstrates the customer-service nature of airline recommendations. Customers seems to prioritize the feeling value of their ticket-price relateive to their travel experience, such as cabin service and seat comfort.</p>
</section>
<section id="decisiontree-model-2-forced-split" class="level2">
<h2 class="anchored" data-anchor-id="decisiontree-model-2-forced-split">DecisionTree Model 2 : Forced Split</h2>
<p>Purposely removing the initial splitting feature of the decision tree will result in a structurally different model. This was achieved by preventing the previously top-ranked feature from being used in the first split of the firstmodel.</p>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>X_train_2 <span class="op">=</span> X_train.drop(<span class="st">'Value For Money'</span>, axis <span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a>X_test_2 <span class="op">=</span> X_test.drop(<span class="st">'Value For Money'</span>, axis <span class="op">=</span><span class="dv">1</span>) <span class="co"># almost forgot about X_test :)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we create another model without <code>Value for Money</code> and see it if its predictive power changes significantly. We could run the GridSearchCV() again to see the best parameters for the truncated X_train. For now, lets stick to the parameters from the first DT model.</p>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a>dt2 <span class="op">=</span> DecisionTreeClassifier(criterion<span class="op">=</span><span class="st">'gini'</span>, max_depth<span class="op">=</span><span class="dv">3</span>, min_samples_leaf<span class="op">=</span><span class="fl">0.1</span>, random_state<span class="op">=</span>SEED)</span>
<span id="cb40-2"><a href="#cb40-2"></a></span>
<span id="cb40-3"><a href="#cb40-3"></a>dt2.fit(X_train_2, y_train)</span>
<span id="cb40-4"><a href="#cb40-4"></a></span>
<span id="cb40-5"><a href="#cb40-5"></a>y_pred2  <span class="op">=</span> dt2.predict(X_test_2)</span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="bu">print</span>(<span class="ss">f'DT Model 2 Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred2)<span class="sc">:.3%}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DT Model 2 Accuracy: 87.356%</code></pre>
</div>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb42-2"><a href="#cb42-2"></a>tree.plot_tree(dt2, feature_names<span class="op">=</span>X_train_2.columns, class_names<span class="op">=</span>[<span class="st">'Not Recommend'</span>, <span class="st">'Recommend'</span>], filled<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-3"><a href="#cb42-3"></a>plt.title(<span class="st">'Decision Tree Model 2'</span>)</span>
<span id="cb42-4"><a href="#cb42-4"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a>importance_dt <span class="op">=</span> pd.Series(dt2.feature_importances_, index <span class="op">=</span> X_train_2.columns)</span>
<span id="cb43-2"><a href="#cb43-2"></a></span>
<span id="cb43-3"><a href="#cb43-3"></a>importance_sorted_dt <span class="op">=</span> importance_dt.sort_values()</span>
<span id="cb43-4"><a href="#cb43-4"></a></span>
<span id="cb43-5"><a href="#cb43-5"></a>importance_sorted_dt.plot(kind<span class="op">=</span><span class="st">'barh'</span>, color <span class="op">=</span> <span class="st">'blue'</span>)</span>
<span id="cb43-6"><a href="#cb43-6"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Excluding the most influential feature, <code>Value for Money</code>, led to a 3% drop in model accuracy. This highlights the significant explanatory power of ‘Value for Money’ in predicting airline recommendations.</p>
</section>
<section id="random-forest-model" class="level2">
<h2 class="anchored" data-anchor-id="random-forest-model">Random Forest Model</h2>
<p>Utilized Grid Search and cross validation to find the optimal paramaters to use for the Random Forest model.</p>
<div id="cell-51" class="cell" data-message="false">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>param_grid_rf <span class="op">=</span> {</span>
<span id="cb44-2"><a href="#cb44-2"></a>     <span class="st">'n_estimators'</span>: [<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">400</span>, <span class="dv">500</span>],</span>
<span id="cb44-3"><a href="#cb44-3"></a>    <span class="st">'criterion'</span>: [<span class="st">'gini'</span>, <span class="st">'entropy'</span>],</span>
<span id="cb44-4"><a href="#cb44-4"></a>    <span class="st">'max_depth'</span>: <span class="bu">range</span>(<span class="dv">3</span>,<span class="dv">10</span>),</span>
<span id="cb44-5"><a href="#cb44-5"></a>    <span class="st">'min_samples_leaf'</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>,<span class="fl">0.15</span>, <span class="fl">0.18</span>]  </span>
<span id="cb44-6"><a href="#cb44-6"></a> }</span>
<span id="cb44-7"><a href="#cb44-7"></a></span>
<span id="cb44-8"><a href="#cb44-8"></a>rf <span class="op">=</span> RandomForestClassifier(random_state<span class="op">=</span>SEED)</span>
<span id="cb44-9"><a href="#cb44-9"></a></span>
<span id="cb44-10"><a href="#cb44-10"></a>gs_rf <span class="op">=</span> GridSearchCV(rf, param_grid<span class="op">=</span>param_grid_rf, cv<span class="op">=</span><span class="dv">5</span>, scoring <span class="op">=</span> <span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb44-11"><a href="#cb44-11"></a>gs_rf.fit(X_train, y_train)</span>
<span id="cb44-12"><a href="#cb44-12"></a></span>
<span id="cb44-13"><a href="#cb44-13"></a>best_params <span class="op">=</span> gs_rf.best_params_</span>
<span id="cb44-14"><a href="#cb44-14"></a><span class="bu">print</span>(best_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'criterion': 'entropy', 'max_depth': 4, 'min_samples_leaf': 0.05, 'n_estimators': 400}</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-message="false">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>rf <span class="op">=</span> RandomForestClassifier(n_estimators <span class="op">=</span> <span class="dv">400</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>,max_depth<span class="op">=</span><span class="dv">4</span>, min_samples_leaf<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb46-2"><a href="#cb46-2"></a>rf.fit(X_train,y_train)</span>
<span id="cb46-3"><a href="#cb46-3"></a></span>
<span id="cb46-4"><a href="#cb46-4"></a>y_pred_rf <span class="op">=</span> rf.predict(X_test)</span>
<span id="cb46-5"><a href="#cb46-5"></a></span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="bu">print</span>(<span class="ss">f'RandomForestClassifier Model Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred_rf)<span class="sc">:.3%}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RandomForestClassifier Model Accuracy: 92.816%</code></pre>
</div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a>importance_rf <span class="op">=</span> pd.Series(rf.feature_importances_, index <span class="op">=</span> X_train.columns)</span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a>importance_sorted_rf <span class="op">=</span> importance_rf.sort_values()</span>
<span id="cb48-4"><a href="#cb48-4"></a></span>
<span id="cb48-5"><a href="#cb48-5"></a>importance_sorted_rf.plot(kind<span class="op">=</span><span class="st">'barh'</span>, color <span class="op">=</span> <span class="st">'blue'</span>)</span>
<span id="cb48-6"><a href="#cb48-6"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="notebook_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-variance-analysis" class="level1">
<h1>Model Variance Analysis</h1>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a>cross_val_score(dt1,X_train,y_train, cv<span class="op">=</span><span class="dv">10</span>, scoring <span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>array([0.84285714, 0.89208633, 0.90647482, 0.89208633, 0.88489209,
       0.9352518 , 0.89928058, 0.8705036 , 0.90647482, 0.89928058])</code></pre>
</div>
</div>
<div id="cell-57" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># DT Model 1 </span></span>
<span id="cb52-2"><a href="#cb52-2"></a>acc_CV_scores <span class="op">=</span> cross_val_score(dt1,X_train,y_train, cv<span class="op">=</span><span class="dv">10</span>, scoring <span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a>mean_cv <span class="op">=</span> acc_CV_scores.mean()</span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="bu">print</span>(<span class="ss">f'CV Mean Accuracy for DT Model 1: </span><span class="sc">{</span>mean_cv<span class="sc">:.3%}</span><span class="ss">'</span>)</span>
<span id="cb52-5"><a href="#cb52-5"></a></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="co"># DT Model 2</span></span>
<span id="cb52-7"><a href="#cb52-7"></a>acc_CV_scores <span class="op">=</span> cross_val_score(dt2,X_train_2,y_train, cv<span class="op">=</span><span class="dv">10</span>, scoring <span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb52-8"><a href="#cb52-8"></a>mean_cv <span class="op">=</span> acc_CV_scores.mean()</span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="bu">print</span>(<span class="ss">f'CV Mean Accuracy for DT Model 2: </span><span class="sc">{</span>mean_cv<span class="sc">:.3%}</span><span class="ss">'</span>)</span>
<span id="cb52-10"><a href="#cb52-10"></a></span>
<span id="cb52-11"><a href="#cb52-11"></a></span>
<span id="cb52-12"><a href="#cb52-12"></a><span class="co"># RandomForest</span></span>
<span id="cb52-13"><a href="#cb52-13"></a>acc_CV_scores <span class="op">=</span> cross_val_score(rf,X_train,y_train, cv<span class="op">=</span><span class="dv">10</span>, scoring <span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb52-14"><a href="#cb52-14"></a>mean_cv <span class="op">=</span> acc_CV_scores.mean()</span>
<span id="cb52-15"><a href="#cb52-15"></a><span class="bu">print</span>(<span class="ss">f'CV Mean Accuracy for RF Model: </span><span class="sc">{</span>mean_cv<span class="sc">:.3%}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CV Mean Accuracy for DT Model 1: 89.292%
CV Mean Accuracy for DT Model 2: 85.044%
CV Mean Accuracy for RF Model: 92.672%</code></pre>
</div>
</div>
<p>Recall, Accuracy from training set:</p>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a><span class="bu">print</span>(<span class="ss">f'DT Model 1 Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred)<span class="sc">:.3%}</span><span class="ss">'</span>)</span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="bu">print</span>(<span class="ss">f'DT Model 2 Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred2)<span class="sc">:.3%}</span><span class="ss">'</span>)</span>
<span id="cb54-3"><a href="#cb54-3"></a><span class="bu">print</span>(<span class="ss">f'RandomForestClassifier Model Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred_rf)<span class="sc">:.3%}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DT Model 1 Accuracy: 90.805%
DT Model 2 Accuracy: 87.356%
RandomForestClassifier Model Accuracy: 92.816%</code></pre>
</div>
</div>
<p>The RF Classifier models demonstrates the highest accuracy on both the training set and the CV results. This is expected from a ensemble model since its reduces vairance and mitigate overfitting relative to a single DecisionTree. Moreover, there is slight drop in accuracy between training and CV scores for all of the models. This suggests a small degree of overfitting.</p>
<p>DT model 2 show the largest difference in scores indicating that DT model 2 is more likely to overfit and have a higher variance on the training set.</p>
<p>In response to the blog, to counter over-fitting the model to the data we used cross-validation and limited paramaters such max_depth to retain the models interpretability as model complexity was mentioned in the blog. Moreover, a random forest model further mitigates the variability by taking the average across a number of decision trees.</p>
<p>In terms of practical applications, from this airline reviews data. Company stackholders can look at the feature importance chart and focues on the Value for Money being above a certain value return a favorable outcome to the company. This is easily understood and be used as evidence to decide company policies.</p>
<p>Another aspect from the blog of metrics relevant, is that we retrain the our models at intervales to adapt the shift in customer opinion or value in order to for the models to relevant.</p>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<p>DataCamp : <a href="https://app.datacamp.com/learn/courses/machine-learning-with-tree-based-models-in-python">ML with Tree-Based Models in Python Module</a></p>
<p>https://scikit-learn.org/</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>